


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>driver &mdash; Psithon for PSI4 documentation</title>
    
    <link rel="stylesheet" href="../_static/psi4.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4.01',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toggle_sections.js"></script>
    <link rel="top" title="Psithon for PSI4 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
    <script type="text/javascript" src="../_static/copybutton.js"></script> 

  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../index.html">Psithon for PSI4 Documentation</a> &raquo; </li>

          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for driver</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">PsiMod</span>
<span class="kn">import</span> <span class="nn">input</span>
<span class="kn">from</span> <span class="nn">proc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">text</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">procutil</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c">#Procedure lookup tables</span>
<span class="n">procedures</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;energy&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;scf&#39;</span>           <span class="p">:</span> <span class="n">run_scf</span><span class="p">,</span>
            <span class="s">&#39;mcscf&#39;</span>         <span class="p">:</span> <span class="n">run_mcscf</span><span class="p">,</span>
            <span class="s">&#39;dcft&#39;</span>          <span class="p">:</span> <span class="n">run_dcft</span><span class="p">,</span>
            <span class="s">&#39;dfmp2&#39;</span>         <span class="p">:</span> <span class="n">run_dfmp2</span><span class="p">,</span>
            <span class="s">&#39;dfcc&#39;</span>          <span class="p">:</span> <span class="n">run_dfcc</span><span class="p">,</span>
            <span class="s">&#39;mp2&#39;</span>           <span class="p">:</span> <span class="n">run_mp2</span><span class="p">,</span>
            <span class="s">&#39;mp2-drpa&#39;</span>      <span class="p">:</span> <span class="n">run_mp2drpa</span><span class="p">,</span>
            <span class="s">&#39;sapt0&#39;</span>         <span class="p">:</span> <span class="n">run_sapt</span><span class="p">,</span>
            <span class="s">&#39;sapt2&#39;</span>         <span class="p">:</span> <span class="n">run_sapt</span><span class="p">,</span>
            <span class="s">&#39;sapt2+&#39;</span>        <span class="p">:</span> <span class="n">run_sapt</span><span class="p">,</span>
            <span class="s">&#39;sapt2+(3)&#39;</span>     <span class="p">:</span> <span class="n">run_sapt</span><span class="p">,</span>
            <span class="s">&#39;sapt2+3&#39;</span>       <span class="p">:</span> <span class="n">run_sapt</span><span class="p">,</span>
            <span class="s">&#39;sapt0-ct&#39;</span>      <span class="p">:</span> <span class="n">run_sapt_ct</span><span class="p">,</span>
            <span class="s">&#39;sapt2-ct&#39;</span>      <span class="p">:</span> <span class="n">run_sapt_ct</span><span class="p">,</span>
            <span class="s">&#39;sapt2+-ct&#39;</span>     <span class="p">:</span> <span class="n">run_sapt_ct</span><span class="p">,</span>
            <span class="s">&#39;sapt2+(3)-ct&#39;</span>  <span class="p">:</span> <span class="n">run_sapt_ct</span><span class="p">,</span>
            <span class="s">&#39;sapt2+3-ct&#39;</span>    <span class="p">:</span> <span class="n">run_sapt_ct</span><span class="p">,</span>
            <span class="s">&#39;mp2c&#39;</span>          <span class="p">:</span> <span class="n">run_mp2c</span><span class="p">,</span>
            <span class="s">&#39;ccenergy&#39;</span>      <span class="p">:</span> <span class="n">run_ccenergy</span><span class="p">,</span>  <span class="c"># full control over ccenergy</span>
            <span class="s">&#39;ccsd&#39;</span>          <span class="p">:</span> <span class="n">run_ccenergy</span><span class="p">,</span>
            <span class="s">&#39;ccsd(t)&#39;</span>       <span class="p">:</span> <span class="n">run_ccenergy</span><span class="p">,</span>
            <span class="s">&#39;cc2&#39;</span>           <span class="p">:</span> <span class="n">run_ccenergy</span><span class="p">,</span>
            <span class="s">&#39;cc3&#39;</span>           <span class="p">:</span> <span class="n">run_ccenergy</span><span class="p">,</span>
            <span class="s">&#39;mrcc&#39;</span>          <span class="p">:</span> <span class="n">run_mrcc</span><span class="p">,</span>      <span class="c"># interface to Kallay&#39;s MRCC program</span>
            <span class="s">&#39;bccd&#39;</span>          <span class="p">:</span> <span class="n">run_bccd</span><span class="p">,</span>
            <span class="s">&#39;bccd(t)&#39;</span>       <span class="p">:</span> <span class="n">run_bccd_t</span><span class="p">,</span>
            <span class="s">&#39;eom-ccsd&#39;</span>      <span class="p">:</span> <span class="n">run_eom_cc</span><span class="p">,</span>
            <span class="s">&#39;eom-cc2&#39;</span>       <span class="p">:</span> <span class="n">run_eom_cc</span><span class="p">,</span>
            <span class="s">&#39;eom-cc3&#39;</span>       <span class="p">:</span> <span class="n">run_eom_cc</span><span class="p">,</span>
            <span class="s">&#39;detci&#39;</span>         <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>  <span class="c"># full control over detci</span>
            <span class="s">&#39;mp&#39;</span>            <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>  <span class="c"># arbitrary order mp(n)</span>
            <span class="s">&#39;zapt&#39;</span>          <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>  <span class="c"># arbitrary order zapt(n)</span>
            <span class="s">&#39;cisd&#39;</span>          <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>
            <span class="s">&#39;cisdt&#39;</span>         <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>
            <span class="s">&#39;cisdtq&#39;</span>        <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>
            <span class="s">&#39;ci&#39;</span>            <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>  <span class="c"># arbitrary order ci(n)</span>
            <span class="s">&#39;fci&#39;</span>           <span class="p">:</span> <span class="n">run_detci</span><span class="p">,</span>
            <span class="s">&#39;adc&#39;</span>           <span class="p">:</span> <span class="n">run_adc</span><span class="p">,</span>
            <span class="s">&#39;cphf&#39;</span>          <span class="p">:</span> <span class="n">run_libfock</span><span class="p">,</span>
            <span class="s">&#39;cis&#39;</span>           <span class="p">:</span> <span class="n">run_libfock</span><span class="p">,</span>
            <span class="s">&#39;tdhf&#39;</span>          <span class="p">:</span> <span class="n">run_libfock</span><span class="p">,</span>
            <span class="s">&#39;cpks&#39;</span>          <span class="p">:</span> <span class="n">run_libfock</span><span class="p">,</span>
            <span class="s">&#39;tda&#39;</span>           <span class="p">:</span> <span class="n">run_libfock</span><span class="p">,</span>
            <span class="s">&#39;tddft&#39;</span>         <span class="p">:</span> <span class="n">run_libfock</span>
            <span class="c"># Upon adding a method to this list, add it to the docstring in energy() below</span>
        <span class="p">},</span>
        <span class="s">&#39;gradient&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;scf&#39;</span>           <span class="p">:</span> <span class="n">run_scf_gradient</span><span class="p">,</span>
            <span class="s">&#39;ccsd&#39;</span>          <span class="p">:</span> <span class="n">run_cc_gradient</span><span class="p">,</span>
            <span class="s">&#39;ccsd(t)&#39;</span>       <span class="p">:</span> <span class="n">run_cc_gradient</span><span class="p">,</span>
            <span class="s">&#39;mp2&#39;</span>           <span class="p">:</span> <span class="n">run_mp2_gradient</span><span class="p">,</span>
            <span class="s">&#39;eom-ccsd&#39;</span>      <span class="p">:</span> <span class="n">run_eom_cc_gradient</span>
            <span class="c"># Upon adding a method to this list, add it to the docstring in optimize() below</span>
        <span class="p">},</span>
        <span class="s">&#39;hessian&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c"># Upon adding a method to this list, add it to the docstring in frequency() below</span>
        <span class="p">},</span>
        <span class="s">&#39;response&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;cc2&#39;</span>  <span class="p">:</span> <span class="n">run_cc_response</span><span class="p">,</span>
            <span class="s">&#39;ccsd&#39;</span> <span class="p">:</span> <span class="n">run_cc_response</span>
            <span class="c"># Upon adding a method to this list, add it to the docstring in response() below</span>
        <span class="p">}}</span>

<div class="viewcode-block" id="energy"><a class="viewcode-back" href="../index.html#driver.energy">[docs]</a><span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to compute the single-point electronic energy.</span>

<span class="sd">    :returns: (*float*) Total electronic energy in Hartrees. SAPT returns interaction energy.</span>

<span class="sd">    :PSI variables:</span>
<span class="sd">    .. envvar:: CURRENT ENERGY</span>
<span class="sd">        CURRENT REFERENCE ENERGY</span>
<span class="sd">        CURRENT CORRELATION ENERGY</span>

<span class="sd">    **Keywords**</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;df-mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method </span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                          | </span>
<span class="sd">    +=========================+=======================================================================================+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) or density functional theory (DFT)                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2                     | 2nd-order Moller-Plesset perturbation theory (MP2)                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | df-mp2                  | MP2 with density fitting                                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | dcft                    | density cumulant functional theory                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mcscf                   | multiconfigurational self consistent field (SCF)                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | dfcc                    | coupled cluster with density fitting                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2c                    | coupled MP2 (MP2C)                                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2-drpa                | random phase approximation?                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt0                   | 0th-order symmetry adapted perturbation theory (SAPT)                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2                   | 2nd-order SAPT, traditional definition                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+                  | SAPT including all 2nd-order terms                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)               | SAPT including perturbative triples                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3                 |                                                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt0-ct                | 0th-order SAPT plus charge transfer (CT) calculation                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2-ct                | SAPT2 plus CT                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+-ct               | SAPT2+ plus CT                                                                        |   </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)-ct            | SAPT2+(3) plus CT                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3-ct              | SAPT2+3 plus CT                                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cc2                     | approximate coupled cluster singles and doubles (CC2)                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd                    | coupled cluster singles and doubles (CCSD)                                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | bccd                    | Brueckner coupled cluster doubles (BCCD)                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cc3                     | approximate coupled cluster singles, doubles, and triples (CC3)                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd(t)                 | CCSD with perturbative triples                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | bccd(t)                 | BCCD with perturbative triples                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccenergy                | **expert** full control over ccenergy module                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp *n*                  | *n* th-order Moller--Plesset perturbation theory                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | zapt *n*                | *n* th-order z-averaged perturbation theory (ZAPT)                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisd                    | configuration interaction (CI) singles and doubles (CISD)                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisdt                   | CI singles, doubles, and triples (CISDT)                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisdtq                  | CI singles, doubles, triples, and quadruples (CISDTQ)                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | ci *n*                  | *n* th-order CI                                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | fci                     | full configuration interaction (FCI)                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | detci                   | **expert** full control over detci module                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cphf                    | coupled-perturbed Hartree-Fock?                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cpks                    | coupled-perturbed Kohn-Sham?                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | cis                     | CI singles (CIS)                                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | tda                     | Tamm-Dankoff approximation (TDA)                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | tdhf                    | time-dependent HF (TDHF)                                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | tddft                   | time-dependent DFT (TDDFT)                                                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | adc                     | 2nd-order algebraic diagrammatic construction (ADC)                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-cc2                 | EOM-CC2                                                                               | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd                | equation of motion (EOM) CCSD                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-cc3                 | EOM-CC3                                                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>


<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method in Kallay&#39;s MRCC program                                                 | </span>
<span class="sd">    +=========================+=======================================================================================+</span>
<span class="sd">    | mrccsd                  | CC through doubles                                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdt                 | CC through triples                                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtq                | CC through quadruples                                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqp               | CC through quintuples                                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqph              | CC through sextuples                                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsd(t)               | CC through doubles with perturbative triples                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdt(q)              | CC through triples with perturbative quadruples                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtq(p)             | CC through quadruples with pertubative quintuples                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqp(h)            | CC through quintuples with pertubative sextuples                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsd(t)_l             |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdt(q)_l            |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtq(p)_l           |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqp(h)_l          |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdt-1a              |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtq-1a             |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqp-1a            |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqph-1a           |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdt-1b              |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtq-1b             |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqp-1b            |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqph-1b           |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrcc2                   |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrcc3                   |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrcc4                   |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrcc5                   |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrcc6                   |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdt-3               |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtq-3              |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqp-3             |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mrccsdtqph-3            |                                                                                       | </span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>

<span class="sd">    **Examples**</span>

<span class="sd">    &gt;&gt;&gt; # [1] Coupled-cluster singles and doubles calculation with psi code</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;ccsd&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Charge-transfer SAPT calculation with scf projection from small into requested basis</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;sapt0-ct&#39;,cast_up=True)</span>

<span class="sd">    &gt;&gt;&gt; # [3] Arbitrary-order MPn calculation</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;mp4&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># Make sure the molecule the user provided is the active one</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;molecule&#39;</span><span class="p">)):</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c"># Allow specification of methods to arbitrary order</span>
    <span class="n">lowername</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">parse_arbitrary_order</span><span class="p">(</span><span class="n">lowername</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">procedures</span><span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Energy method </span><span class="si">%s</span><span class="s"> not available.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lowername</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="gradient"><a class="viewcode-back" href="../index.html#driver.gradient">[docs]</a><span class="k">def</span> <span class="nf">gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function complementary to optimize(). Carries out one gradient pass,</span>
<span class="sd">    deciding analytic or finite difference.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">dertype</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c"># Order of precedence:</span>
    <span class="c">#    1. Default for wavefunction</span>
    <span class="c">#    2. Value obtained from kwargs, if user changed it</span>
    <span class="c">#    3. If user provides a custom &#39;func&#39; use that</span>

    <span class="c"># Allow specification of methods to arbitrary order</span>
    <span class="n">lowername</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">parse_arbitrary_order</span><span class="p">(</span><span class="n">lowername</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>

    <span class="c"># 1. set the default to that of the provided name</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">procedures</span><span class="p">[</span><span class="s">&#39;gradient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lowername</span><span class="p">)):</span>
        <span class="n">dertype</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">procedures</span><span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lowername</span><span class="p">)):</span>
        <span class="n">dertype</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">energy</span>

    <span class="c"># 2. Check if the user passes dertype into this function</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;dertype&#39;</span><span class="p">)):</span>
        <span class="n">opt_dertype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;dertype&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">der0th</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">opt_dertype</span><span class="p">)):</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="k">elif</span> <span class="nb">input</span><span class="o">.</span><span class="n">der1st</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">opt_dertype</span><span class="p">)):</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested derivative level </span><span class="se">\&#39;</span><span class="s">dertype</span><span class="se">\&#39;</span><span class="s"> </span><span class="si">%s</span><span class="s"> not valid for helper function optimize.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_dertype</span><span class="p">))</span>

    <span class="c"># 3. if the user provides a custom function THAT takes precendence</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;opt_func&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;func&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;func&#39;</span><span class="p">)):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;opt_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
        <span class="n">dertype</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;opt_func&#39;</span><span class="p">]</span>

    <span class="c"># Summary validation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">procedures</span><span class="p">[</span><span class="s">&#39;gradient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lowername</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="n">energy</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">procedures</span><span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lowername</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="n">energy</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested method </span><span class="se">\&#39;</span><span class="s">name</span><span class="se">\&#39;</span><span class="s"> </span><span class="si">%s</span><span class="s"> and derivative level </span><span class="se">\&#39;</span><span class="s">dertype</span><span class="se">\&#39;</span><span class="s"> </span><span class="si">%s</span><span class="s"> are not available.&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">dertype</span><span class="p">))</span>

    <span class="c"># Make sure the molecule the user provided is the active one</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;molecule&#39;</span><span class="p">)):</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">))</span>

    <span class="c"># S/R: Mode of operation- whether finite difference opt run in one job or files farmed out</span>
    <span class="n">opt_mode</span> <span class="o">=</span> <span class="s">&#39;continuous&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">opt_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;continuous&#39;</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;linkage&#39;</span><span class="p">)):</span>
            <span class="n">opt_linkage</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;linkage&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Optimize execution mode </span><span class="se">\&#39;</span><span class="s">reap</span><span class="se">\&#39;</span><span class="s"> requires a linkage option.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Optimize execution mode </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_mode</span><span class="p">))</span>

    <span class="c"># Does dertype indicate an analytic procedure both exists and is wanted?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c"># Nothing to it but to do it. Gradient information is saved</span>
        <span class="c"># into the current reference wavefunction</span>
        <span class="n">procedures</span><span class="p">[</span><span class="s">&#39;gradient&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">reference_wavefunction</span><span class="p">()</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># If not, perform finite difference of energies</span>

        <span class="n">opt_iter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;opt_iter&#39;</span><span class="p">)):</span>
            <span class="n">opt_iter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;opt_iter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">opt_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Performing finite difference calculations&#39;</span>

        <span class="c"># Obtain list of displacements</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">fd_geoms_1_0</span><span class="p">()</span>
        <span class="n">ndisp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">displacements</span><span class="p">)</span>

        <span class="c"># This version is pretty dependent on the reference geometry being last (as it is now)</span>
        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> displacements needed ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ndisp</span><span class="p">),</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># S/R: Write instructions for sow/reap procedure to output file and reap input file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
            <span class="n">instructionsO</span>  <span class="o">=</span>   <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">    The optimization sow/reap procedure has been selected through mode=&#39;sow&#39;. In addition</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;    to this output file (which contains no quantum chemical calculations), this job</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;    has produced a number of input files (OPT-</span><span class="si">%s</span><span class="s">-*.in) for individual components</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">opt_iter</span><span class="p">))</span>
            <span class="n">instructionsO</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;    and a single input file (OPT-master.in) with an optimize(mode=&#39;reap&#39;) command.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;    These files may look very peculiar since they contain processed and pickled python</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;    rather than normal input. Follow the instructions in OPT-master.in to continue.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;    Alternatively, a single-job execution of the gradient may be accessed through</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;    the optimization wrapper option mode=&#39;continuous&#39;.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructionsO</span><span class="p">)</span>

            <span class="n">instructionsM</span>  <span class="o">=</span>   <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">#    Follow the instructions below to carry out this optimization cycle.</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#    (1)  Run all of the OPT-</span><span class="si">%s</span><span class="s">-*.in input files on any variety of computer architecture.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">opt_iter</span><span class="p">))</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#       The output file names must be as given below.</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndisp</span><span class="p">):</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s">&#39;OPT-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt_iter</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rgt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s">&#39;.in&#39;</span><span class="p">,</span> <span class="n">pre</span> <span class="o">+</span> <span class="s">&#39;.out&#39;</span><span class="p">)</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>  <span class="s">&quot;&quot;&quot;#</span><span class="se">\n</span><span class="s">#    (2)  Gather all the resulting output files in a directory. Place input file</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#         OPT-master.in into that directory and run it. The job will be minimal in</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#         length and give summary results for the gradient step in its output file.</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">opt_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s">&#39;OPT-master.out&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;#             psi4 -a -i </span><span class="si">%-27s</span><span class="s"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s">&#39;OPT-master.out&#39;</span><span class="p">)</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#    After each optimization iteration, the OPT-master.in file is overwritten so return here</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#    for new instructions. With the use of the psi4 -a flag, OPT-master.out is not</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#    overwritten and so maintains a history of the job. To use the (binary) optimizer</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span>     <span class="s">&quot;&quot;&quot;#    data file to accelerate convergence, the OPT-master jobs must run on the same computer.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>

            <span class="n">fmaster</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# This is a psi4 input file auto-generated from the gradient() wrapper.</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">molecule</span><span class="p">))</span>
            <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_options_for_input</span><span class="p">())</span>
            <span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">fmaster</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s">(&#39;</span><span class="si">%s</span><span class="s">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">optimize</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span>
            <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">instructionsM</span><span class="p">)</span>
            <span class="n">fmaster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">displacement</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displacements</span><span class="p">):</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="s">&#39;OPT-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_iter</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># Build string of title banner</span>
            <span class="n">banners</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;banner(&#39; Gradient </span><span class="si">%d</span><span class="s"> Computation: Displacement </span><span class="si">%d</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_iter</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;continuous&#39;</span><span class="p">):</span>
                <span class="c"># Print information to output.dat</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">banner</span><span class="p">(</span><span class="s">&quot;Loading displacement </span><span class="si">%d</span><span class="s"> of </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndisp</span><span class="p">))</span>

                <span class="c"># Print information to the screen</span>
                <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">ndisp</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>

                <span class="c"># Load in displacement into the active molecule</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c"># Perform the energy calculation</span>
                <span class="c">#E = func(lowername, **kwargs)</span>
                <span class="n">func</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">)</span>
                <span class="c">#E = func(**kwargs)</span>

                <span class="c"># Save the energy</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

            <span class="c"># S/R: Write each displaced geometry to an input file</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c"># S/R: Prepare molecule, options, and kwargs</span>
                <span class="n">freagent</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.in&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# This is a psi4 input file auto-generated from the gradient() wrapper.</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">molecule</span><span class="p">))</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_options_for_input</span><span class="p">())</span>
                <span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">freagent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="c"># S/R: Prepare function call and energy save</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;electronic_energy = </span><span class="si">%s</span><span class="s">(&#39;</span><span class="si">%s</span><span class="s">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">nGRADIENT RESULT: computation </span><span class="si">%d</span><span class="s"> for item </span><span class="si">%d</span><span class="s"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;yields electronic energy </span><span class="si">%20.12f</span><span class="se">\\</span><span class="s">n&#39; % (electronic_energy))</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c"># S/R: Read energy from each displaced geometry output file and save in energies array</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">):</span>
                <span class="n">E</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">exec</span> <span class="n">banners</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">freagent</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.out&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Aborting upon output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> not found.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">))</span>
                    <span class="k">return</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">freagent</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">E</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                               <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Aborting upon output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> has no </span><span class="si">%s</span><span class="s"> RESULT line.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="s">&#39;GRADIENT&#39;</span><span class="p">))</span>
                            <span class="k">break</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;GRADIENT&#39;</span><span class="p">,</span> <span class="s">&#39;RESULT:&#39;</span><span class="p">,</span> <span class="s">&#39;computation&#39;</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="n">opt_linkage</span><span class="p">:</span>
                               <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> has linkage </span><span class="si">%s</span><span class="s"> incompatible with master.in linkage </span><span class="si">%s</span><span class="s">.&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt_linkage</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                               <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> has nominal affiliation </span><span class="si">%s</span><span class="s"> incompatible with item </span><span class="si">%s</span><span class="s">.&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;electronic&#39;</span><span class="p">,</span> <span class="s">&#39;energy&#39;</span><span class="p">]):</span>
                                <span class="n">E</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
                                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> RESULT: electronic energy = </span><span class="si">%20.12f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;GRADIENT&#39;</span><span class="p">,</span> <span class="n">E</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="c"># S/R: Quit sow after writing files</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">):</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># Obtain the gradient</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">fd_1_0</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

        <span class="c"># The last item in the list is the reference energy, return it</span>
        <span class="k">return</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="response"><a class="viewcode-back" href="../index.html#driver.response">[docs]</a><span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to compute linear response properties.</span>

<span class="sd">    :returns: (*float*) Total electronic energy in Hartrees.</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - Check that energy is actually being returned.</span>

<span class="sd">       - Check if ther&#39;re some PSI variables that ought to be set.</span>

<span class="sd">    **Keywords**</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;ccsd&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method </span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                          | </span>
<span class="sd">    +=========================+=======================================================================================+</span>
<span class="sd">    | cc2                     | 2nd-order approximate CCSD                                                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd                    | coupled cluster singles and doubles (CCSD)                                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>

<span class="sd">    **Examples**</span>

<span class="sd">    &gt;&gt;&gt; # [1] CCSD-LR properties calculation</span>
<span class="sd">    &gt;&gt;&gt; response(&#39;ccsd&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># Make sure the molecule the user provided is the active one</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;molecule&#39;</span><span class="p">)):</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">procedures</span><span class="p">[</span><span class="s">&#39;response&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Response method </span><span class="si">%s</span><span class="s"> not available.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">lowername</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="optimize"><a class="viewcode-back" href="../index.html#driver.optimize">[docs]</a><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to perform a geometry optimization.</span>

<span class="sd">    :aliases: opt()</span>

<span class="sd">    :returns: (*float*) Total electronic energy of optimized structure in Hartrees.</span>

<span class="sd">    :PSI variables:</span>
<span class="sd">    .. envvar:: CURRENT ENERGY</span>

<span class="sd">    .. note:: Analytic gradients area available for all methods in the table</span>
<span class="sd">        below. Optimizations with other methods in the energy table proceed</span>
<span class="sd">        by finite differences.</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - Need to check that all methods do return electronic energy. I think gradient got changed at one point.</span>

<span class="sd">    **Keywords**</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;df-mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method </span>
<span class="sd">        to be applied to the database. May be any valid argument to </span>
<span class="sd">        :py:func:`driver.energy`.</span>

<span class="sd">    :type func: function</span>
<span class="sd">    :param func: |dl| ``gradient`` |dr| || ``energy`` || ``cbs``</span>
<span class="sd">    </span>
<span class="sd">        Indicates the type of calculation to be performed on the molecule.</span>
<span class="sd">        The default dertype accesses``&#39;gradient&#39;`` or ``&#39;energy&#39;``, while</span>
<span class="sd">        ``&#39;cbs&#39;`` performs a multistage finite difference calculation.</span>
<span class="sd">        If a nested series of python functions is intended (see :ref:`sec_intercalls`),</span>
<span class="sd">        use keyword ``opt_func`` instead of ``func``.</span>

<span class="sd">    :type mode: string</span>
<span class="sd">    :param mode: |dl| ``&#39;continuous&#39;`` |dr| || ``&#39;sow&#39;`` || ``&#39;reap&#39;``</span>

<span class="sd">        Indicates whether the calculation required to complete the</span>
<span class="sd">        optimization are to be run in one file (``&#39;continuous&#39;``) or are to be</span>
<span class="sd">        farmed out in an embarrassingly parallel fashion</span>
<span class="sd">        (``&#39;sow&#39;``/``&#39;reap&#39;``).  For the latter, run an initial job with</span>
<span class="sd">        ``&#39;sow&#39;`` and follow instructions in its output file.</span>

<span class="sd">    :type dertype: dertype</span>
<span class="sd">    :param dertype: ``&#39;gradient&#39;`` || ``&#39;energy&#39;``</span>

<span class="sd">        Indicates whether analytic (if available) or finite difference</span>
<span class="sd">        optimization is to be performed.</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                          | </span>
<span class="sd">    +=========================+=======================================================================================+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) or density functional theory (DFT)                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2                     | 2nd-order Moller-Plesset perturbation theory (MP2)                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd                    | coupled cluster singles and doubles (CCSD)                                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd(t)                 | CCSD with perturbative triples                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd                | equation of motion (EOM) CCSD                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------+</span>

<span class="sd">    **Examples**</span>

<span class="sd">    &gt;&gt;&gt; # [1] Analytic scf optimization</span>
<span class="sd">    &gt;&gt;&gt; optimize(&#39;scf&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Finite difference mp3 optimization</span>
<span class="sd">    &gt;&gt;&gt; opt(&#39;mp3&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [3] Forced finite difference ccsd optimization</span>
<span class="sd">    &gt;&gt;&gt; optimize(&#39;ccsd&#39;, dertype=1)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">full_hess_every</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&quot;FULL_HESS_EVERY&quot;</span><span class="p">)</span>
    <span class="n">steps_since_last_hessian</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;opt_iter&#39;</span><span class="p">)):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;opt_iter&#39;</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;GEOM_MAXITER&#39;</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;opt_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

        <span class="c"># Compute the gradient</span>
        <span class="n">thisenergy</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># S/R: Quit after getting new displacements or if forming gradient fails</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">thisenergy</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c"># S/R: Move opt data file from last pass into namespace for this pass</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_path</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;./&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;opt_datafile&#39;</span><span class="p">):</span>
                <span class="n">restartfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;opt_datafile&#39;</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">PsiMod</span><span class="o">.</span><span class="n">me</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">restartfile</span><span class="p">,</span> <span class="n">get_psifile</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="c"># compute Hessian as requested; frequency wipes out gradient so stash it</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">full_hess_every</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">steps_since_last_hessian</span> <span class="o">==</span> <span class="n">full_hess_every</span><span class="p">):</span>
          <span class="n">G</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_gradient</span><span class="p">()</span>
          <span class="n">PsiMod</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
          <span class="n">PsiMod</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_path</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;./&#39;</span><span class="p">)</span>
          <span class="n">frequencies</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
          <span class="n">steps_since_last_hessian</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_gradient</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
          <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;CART_HESS_READ&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;CART_HESS_READ&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">steps_since_last_hessian</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Take step</span>
        <span class="k">if</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">optking</span><span class="p">()</span> <span class="o">==</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">PsiReturnType</span><span class="o">.</span><span class="n">EndLoop</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Optimizer: Optimization complete!&quot;</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">print_in_input_format</span><span class="p">()</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">opt_clean</span><span class="p">()</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

            <span class="c"># S/R: Clean up opt input file</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">):</span>
                <span class="n">fmaster</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# This is a psi4 input file auto-generated from the gradient() wrapper.</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# Optimization complete!</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">thisenergy</span>

        <span class="c"># S/R: Preserve opt data file for next pass and switch modes to get new displacements</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;opt_datafile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_psifile</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;sow&#39;</span>

        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Optimizer: Did not converge!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.0</span>

<span class="c">##  Aliases  ##</span></div>
<span class="n">opt</span> <span class="o">=</span> <span class="n">optimize</span>

<div class="viewcode-block" id="parse_arbitrary_order"><a class="viewcode-back" href="../index.html#driver.parse_arbitrary_order">[docs]</a><span class="k">def</span> <span class="nf">parse_arbitrary_order</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to parse name string into a method family like CI or MRCC and specific</span>
<span class="sd">    level information like 4 for CISDTQ or MRCCSDTQ.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">namelower</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c"># matches &#39;mrccsdt(q)&#39;</span>
    <span class="k">if</span> <span class="n">namelower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;mrcc&#39;</span><span class="p">):</span>
        <span class="c"># grabs &#39;sdt(q)&#39;</span>
        <span class="n">ccfullname</span> <span class="o">=</span> <span class="n">namelower</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>

        <span class="c"># A negative order indicates perturbative method</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;sd&quot;</span>          <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSD&quot;</span>         <span class="p">},</span>
            <span class="s">&quot;sdt&quot;</span>         <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDT&quot;</span>        <span class="p">},</span>
            <span class="s">&quot;sdtq&quot;</span>        <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQ&quot;</span>       <span class="p">},</span>
            <span class="s">&quot;sdtqp&quot;</span>       <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQP&quot;</span>      <span class="p">},</span>
            <span class="s">&quot;sdtqph&quot;</span>      <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQPH&quot;</span>     <span class="p">},</span>
            <span class="s">&quot;sd(t)&quot;</span>       <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSD(T)&quot;</span>      <span class="p">},</span>
            <span class="s">&quot;sdt(q)&quot;</span>      <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDT(Q)&quot;</span>     <span class="p">},</span>
            <span class="s">&quot;sdtq(p)&quot;</span>     <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQ(P)&quot;</span>    <span class="p">},</span>
            <span class="s">&quot;sdtqp(h)&quot;</span>    <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQP(H)&quot;</span>   <span class="p">},</span>
            <span class="s">&quot;sd(t)_l&quot;</span>     <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSD(T)_L&quot;</span>    <span class="p">},</span>
            <span class="s">&quot;sdt(q)_l&quot;</span>    <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDT(Q)_L&quot;</span>   <span class="p">},</span>
            <span class="s">&quot;sdtq(p)_l&quot;</span>   <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQ(P)_L&quot;</span>  <span class="p">},</span>
            <span class="s">&quot;sdtqp(h)_l&quot;</span>  <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQP(H)_L&quot;</span> <span class="p">},</span>
            <span class="s">&quot;sdt-1a&quot;</span>      <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDT-1a&quot;</span>     <span class="p">},</span>
            <span class="s">&quot;sdtq-1a&quot;</span>     <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQ-1a&quot;</span>    <span class="p">},</span>
            <span class="s">&quot;sdtqp-1a&quot;</span>    <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQP-1a&quot;</span>   <span class="p">},</span>
            <span class="s">&quot;sdtqph-1a&quot;</span>   <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQPH-1a&quot;</span>  <span class="p">},</span>
            <span class="s">&quot;sdt-1b&quot;</span>      <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDT-1b&quot;</span>     <span class="p">},</span>
            <span class="s">&quot;sdtq-1b&quot;</span>     <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQ-1b&quot;</span>    <span class="p">},</span>
            <span class="s">&quot;sdtqp-1b&quot;</span>    <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQP-1b&quot;</span>   <span class="p">},</span>
            <span class="s">&quot;sdtqph-1b&quot;</span>   <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQPH-1b&quot;</span>  <span class="p">},</span>
            <span class="s">&quot;2&quot;</span>           <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CC2&quot;</span>          <span class="p">},</span>
            <span class="s">&quot;3&quot;</span>           <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CC3&quot;</span>          <span class="p">},</span>
            <span class="s">&quot;4&quot;</span>           <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CC4&quot;</span>          <span class="p">},</span>
            <span class="s">&quot;5&quot;</span>           <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CC5&quot;</span>          <span class="p">},</span>
            <span class="s">&quot;6&quot;</span>           <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CC6&quot;</span>          <span class="p">},</span>
            <span class="s">&quot;sdt-3&quot;</span>       <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDT-3&quot;</span>      <span class="p">},</span>
            <span class="s">&quot;sdtq-3&quot;</span>      <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQ-3&quot;</span>     <span class="p">},</span>
            <span class="s">&quot;sdtqp-3&quot;</span>     <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQP-3&quot;</span>    <span class="p">},</span>
            <span class="s">&quot;sdtqph-3&quot;</span>    <span class="p">:</span> <span class="p">{</span> <span class="s">&quot;method&quot;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;order&quot;</span> <span class="p">:</span>  <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fullname&quot;</span> <span class="p">:</span> <span class="s">&quot;CCSDTQPH-3&quot;</span>   <span class="p">}</span>
        <span class="p">}</span>

        <span class="c"># looks for &#39;sdt(q)&#39; in dictionary</span>
        <span class="k">if</span> <span class="n">methods</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">ccfullname</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;mrcc&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="p">[</span><span class="n">ccfullname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;MRCC method </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> invalid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namelower</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^[a-z]+\d+$&#39;</span><span class="p">,</span> <span class="n">namelower</span><span class="p">):</span>
        <span class="n">decompose</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^([a-z]+)(\d+)$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">namelower</span><span class="p">)</span>
        <span class="n">namestump</span> <span class="o">=</span> <span class="n">decompose</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">namelevel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">decompose</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">namestump</span> <span class="o">==</span> <span class="s">&#39;mp&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">namestump</span> <span class="o">==</span> <span class="s">&#39;zapt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">namestump</span> <span class="o">==</span> <span class="s">&#39;ci&#39;</span><span class="p">):</span>
            <span class="c"># Let &#39;mp2&#39; pass through as itself</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">namestump</span> <span class="o">==</span> <span class="s">&#39;mp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">namelevel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">namelower</span><span class="p">,</span> <span class="bp">None</span>
            <span class="c"># Otherwise return method and order</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">namestump</span><span class="p">,</span> <span class="n">namelevel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">namelower</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">namelower</span><span class="p">,</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="frequency"><a class="viewcode-back" href="../index.html#driver.frequency">[docs]</a><span class="k">def</span> <span class="nf">frequency</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to compute harmonic vibrational frequencies.</span>

<span class="sd">    :aliases: frequency(), freq()</span>

<span class="sd">    :returns: (*float*) Total electronic energy in Hartrees.</span>

<span class="sd">    :PSI variables:</span>
<span class="sd">    .. envvar:: &lt;PSI VARIABLE SET BY FUNCTION&gt;</span>
<span class="sd">        &lt;ANOTHER PSI VARIABLE WITH nonstandard PORTION OF NAME&gt;</span>

<span class="sd">    .. note:: &lt;Notes for the user</span>
<span class="sd">        of an informative nature.&gt;</span>

<span class="sd">    .. warning:: &lt;Notes for the user</span>
<span class="sd">        of a cautionary nature.&gt;</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - RAK, why are you adding OPTKING options as GLOBALS? (And should they be Py-side not C-side options.)</span>

<span class="sd">       - Put in a dictionary, so IRREPS can be called by point group or &#39;all&#39;</span>

<span class="sd">    **Keywords**</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;df-mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method </span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    :type dertype: dertype</span>
<span class="sd">    :param dertype: |dl| ``&#39;hessian&#39;`` |dr| || ``&#39;gradient&#39;`` || ``&#39;energy&#39;``</span>

<span class="sd">        Indicates whether analytic (if available- they&#39;re not), finite</span>
<span class="sd">        difference of gradients (if available) or finite difference of </span>
<span class="sd">        energies is to be performed.</span>

<span class="sd">    :type irrep: int</span>
<span class="sd">    :param irrep: |dl| ``-1`` |dr| || ``1`` || etc.</span>

<span class="sd">        Indicates which symmetry block of vibrational freqiencies to be</span>
<span class="sd">        computed. 1 represents :math:`a_1`, requesting only the totally symmetric modes.</span>
<span class="sd">        ``-1`` indicates a full frequency calculation.</span>

<span class="sd">    **Examples**</span>

<span class="sd">    &gt;&gt;&gt; # [1] &lt;example description&gt;</span>
<span class="sd">    &gt;&gt;&gt; &lt;example python command&gt;</span>

<span class="sd">    &gt;&gt;&gt; # [2] Frequency calculation for b2 modes through finite difference of gradients</span>
<span class="sd">    &gt;&gt;&gt; frequencies(&#39;scf&#39;, dertype=1, irrep=4)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># Make sure the molecule the user provided is the active one</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;molecule&#39;</span><span class="p">)):</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">))</span>

    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;energy&quot;</span><span class="p">,</span> <span class="s">&quot;gradient&quot;</span><span class="p">,</span> <span class="s">&quot;hessian&quot;</span> <span class="p">]</span>

    <span class="n">dertype</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;dertype&#39;</span><span class="p">)):</span>
        <span class="n">dertype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;dertype&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">procedures</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="n">dertype</span><span class="p">]]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lowername</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Frequencies: dertype = </span><span class="si">%d</span><span class="s"> for frequencies is not available, switching to automatic determination.&quot;</span> <span class="o">%</span> <span class="n">dertype</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;irrep&#39;</span><span class="p">)):</span>
        <span class="n">irrep</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;irrep&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="c"># externally, A1 irrep is 1; internally 0</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">irrep</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c"># -1 implies do all irreps</span>

    <span class="c"># By default, set func to the energy function</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">func_existed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;func&#39;</span><span class="p">)):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
        <span class="n">func_existed</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;dertype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">dertype</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">procedures</span><span class="p">[</span><span class="s">&#39;hessian&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lowername</span><span class="p">):</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">procedures</span><span class="p">[</span><span class="s">&#39;gradient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lowername</span><span class="p">):</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># Does an analytic procedure exist for the requested method?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">func_existed</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
        <span class="c"># We have the desired method. Do it.</span>
        <span class="n">procedures</span><span class="p">[</span><span class="s">&#39;hessian&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">reference_wavefunction</span><span class="p">()</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">func_existed</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
        <span class="c"># Ok, we&#39;re doing frequencies by gradients</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s">&quot;Performing finite difference by gradient calculations&quot;</span>
        <span class="k">print</span> <span class="n">info</span>

        <span class="n">func</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s">&#39;gradient&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">]</span>

        <span class="c"># Obtain list of displacements</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">fd_geoms_freq_1</span><span class="p">(</span><span class="n">irrep</span><span class="p">)</span>

        <span class="n">molecule</span><span class="o">.</span><span class="n">reinterpret_coordentry</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">ndisp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">displacements</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> displacements needed.&quot;</span> <span class="o">%</span> <span class="n">ndisp</span>

        <span class="c">#print displacements to output.dat</span>
        <span class="c">#for n, displacement in enumerate(displacements):</span>
        <span class="c">#  displacement.print_out();</span>

        <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">displacement</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displacements</span><span class="p">):</span>
            <span class="c"># Print information to output.dat</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">banner</span><span class="p">(</span><span class="s">&quot;Loading displacement </span><span class="si">%d</span><span class="s"> of </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndisp</span><span class="p">))</span>

            <span class="c"># Print information to the screen</span>
            <span class="k">print</span> <span class="s">&quot;    displacement </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># Load in displacement into the active molecule (xyz coordinates only)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

            <span class="c"># Perform the gradient calculation</span>
            <span class="n">func</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c"># Save the gradient</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_gradient</span><span class="p">()</span>
            <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

            <span class="c"># clean may be necessary when changing irreps of displacements</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

        <span class="n">PsiMod</span><span class="o">.</span><span class="n">fd_freq_1</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">irrep</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&quot; Computation complete.&quot;</span>

        <span class="c"># TODO: These need to be restored to the user specified setting</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># But not this one, it always goes back to True</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">reinterpret_coordentry</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c"># Assume energy points</span>
        <span class="c"># If not, perform finite difference of energies</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s">&quot;Performing finite difference calculations by energies&quot;</span>
        <span class="k">print</span> <span class="n">info</span>

        <span class="c"># Obtain list of displacements</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">fd_geoms_freq_0</span><span class="p">(</span><span class="n">irrep</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">reinterpret_coordentry</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">ndisp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">displacements</span><span class="p">)</span>

        <span class="c"># This version is pretty dependent on the reference geometry being last (as it is now)</span>
        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%d</span><span class="s"> displacements needed.&quot;</span> <span class="o">%</span> <span class="n">ndisp</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">displacement</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displacements</span><span class="p">):</span>
            <span class="c"># Print information to output.dat</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">banner</span><span class="p">(</span><span class="s">&quot;Loading displacement </span><span class="si">%d</span><span class="s"> of </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndisp</span><span class="p">))</span>

            <span class="c"># Print information to the screen</span>
            <span class="k">print</span> <span class="s">&quot;    displacement </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># Load in displacement into the active molecule</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

            <span class="c"># Perform the energy calculation</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c"># Save the energy</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

            <span class="c"># clean may be necessary when changing irreps of displacements</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

        <span class="c"># Obtain the gradient. This function stores the gradient into the reference wavefunction.</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">fd_freq_0</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">irrep</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&quot; Computation complete.&quot;</span>

        <span class="c"># TODO: These need to be restored to the user specified setting</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># But not this one, it always goes back to True</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">reinterpret_coordentry</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># The last item in the list is the reference energy, return it</span>
        <span class="k">return</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c">## Aliases ##</span></div>
<span class="n">frequencies</span> <span class="o">=</span> <span class="n">frequency</span>
<span class="n">freq</span> <span class="o">=</span> <span class="n">frequency</span>

<span class="c"># hessian to be changed later to compute force constants</span>
<div class="viewcode-block" id="hessian"><a class="viewcode-back" href="../index.html#driver.hessian">[docs]</a><span class="k">def</span> <span class="nf">hessian</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to compute force constants. Presently identical to frequency().&quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">frequencies</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../index.html">Psithon for PSI4 Documentation</a> &raquo; </li>

          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, Psi4 Project.
      Last updated on Feb 22, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>