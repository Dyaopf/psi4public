


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial 4: Using SQL &mdash; Psithon for PSI4 documentation</title>
    
    <link rel="stylesheet" href="../../_static/psi4.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '4.01',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/toggle_sections.js"></script>
    <link rel="top" title="Psithon for PSI4 documentation" href="../../index.html" /> 
    <script type="text/javascript" src="../../_static/copybutton.js"></script> 

  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../index.html">Psithon for PSI4 Documentation</a> &raquo; </li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tutorial-4-using-sql">
<span id="tutorial4"></span><h1>Tutorial 4: Using SQL<a class="headerlink" href="#tutorial-4-using-sql" title="Permalink to this headline">¶</a></h1>
<p>Trackers allow you to use all the flexibility of python to generate
data sources. In the previous Tutorial <a class="reference internal" href="Tutorial3.html#tutorial3"><em>Tutorial 3: Using slices</em></a> the data
was computed directly by the Tracker. More often, the data is computed
elsewhere and stored in a database. <tt class="xref py py-mod docutils literal"><span class="pre">SphinxReport</span></tt> provides a
tracker <tt class="xref py py-class docutils literal"><span class="pre">Tracker.TrackerSQL</span></tt> that facilitates obtaining data
from an SQL database.</p>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>In order to use SQL connectivity, the option <tt class="docutils literal"><span class="pre">sql_backend</span></tt> needs to be set.
in the file <tt class="file docutils literal"><span class="pre">conf.py</span></tt>. <tt class="docutils literal"><span class="pre">sql_backend</span></tt> is passed ot the
<tt class="xref py py-mod docutils literal"><span class="pre">sql_alchemy</span></tt> <tt class="xref py py-meth docutils literal"><span class="pre">create_engine()</span></tt> method to connect to an SQL database.
For more information see the <a class="reference external" href="http://www.sqlalchemy.org/docs/04/dbengine.html">sqlalchemy documentation</a>.</p>
<p>The tutorial assumes that <a class="reference external" href="http://www.sqlite.org/">sqlite</a> has been installed.
First, set <tt class="docutils literal"><span class="pre">sql_backend</span></tt> in <tt class="file docutils literal"><span class="pre">conf.py</span></tt> to</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sql_backend</span><span class="o">=</span><span class="s">&quot;sqlite:///</span><span class="si">%s</span><span class="s">/csvdb&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will tell the Trackers to look for a sqlite database called <tt class="docutils literal"><span class="pre">csvdb</span></tt> in
the root installation directory.</p>
<p>Let us add some data to the database. Create a small python script fill.py
in the current directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;sqlite3 csvdb &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span>

<span class="k">def</span> <span class="nf">e</span><span class="p">(</span> <span class="n">stmt</span> <span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span> <span class="n">cmd</span> <span class="o">%</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span> <span class="p">)</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">e</span><span class="p">(</span><span class="s">&quot;CREATE TABLE experiment1_data (gene_id TEXT, function TEXT, expression INT)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">e</span><span class="p">(</span> <span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (&#39;gene</span><span class="si">%2i</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, </span><span class="si">%f</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;experiment1_data&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s">&quot;housekeeping&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">e</span><span class="p">(</span> <span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (&#39;gene</span><span class="si">%2i</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, </span><span class="si">%f</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;experiment1_data&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;regulation&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">)</span>

<span class="n">e</span><span class="p">(</span><span class="s">&quot;CREATE TABLE experiment2_data (gene_id TEXT, function TEXT, expression INT)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">e</span><span class="p">(</span> <span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (&#39;gene</span><span class="si">%2i</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, </span><span class="si">%f</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;experiment2_data&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s">&quot;housekeeping&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">e</span><span class="p">(</span> <span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (&#39;gene</span><span class="si">%2i</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, </span><span class="si">%f</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;experiment2_data&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;regulation&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">)</span>
</pre></div>
</div>
<p>The script will create two tables called <tt class="docutils literal"><span class="pre">experiment1_data</span></tt> and
<tt class="docutils literal"><span class="pre">experiment2_data</span></tt> and fill them with random data. The data is thought
to have come from two experiments measuring expression level in genes
that are either thought to encode housekeeping functions are regulatory
functions.</p>
</div>
<div class="section" id="building-a-tracker">
<h2>Building a tracker<a class="headerlink" href="#building-a-tracker" title="Permalink to this headline">¶</a></h2>
<p>Create the file <tt class="file docutils literal"><span class="pre">Tutorial4.py</span></tt> in the <tt class="file docutils literal"><span class="pre">python</span></tt> subdirectory and add
the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">SphinxReport.DataTypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">SphinxReport.Tracker</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">ExpressionLevel</span><span class="p">(</span><span class="n">TrackerSQL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Counting word size.&quot;&quot;&quot;</span>
    <span class="n">mPattern</span> <span class="o">=</span> <span class="s">&quot;_data$&quot;</span>

    <span class="nd">@returnSingleColumnData</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="nb">slice</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s">&quot;SELECT expression FROM </span><span class="si">%s</span><span class="s">_data&quot;</span> <span class="o">%</span> <span class="n">track</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValues</span><span class="p">(</span> <span class="n">statement</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>Note that this tracker is derived from <tt class="xref py py-class docutils literal"><span class="pre">Tracker.TrackerSQL</span></tt>. The base
class provides two options. It implements a <tt class="xref py py-meth docutils literal"><span class="pre">getTracks()</span></tt> method that
automatically queries the database for tables matching the pattern
in <tt class="docutils literal"><span class="pre">mPattern</span></tt>. It also defines convenience functions as <tt class="xref py py-meth docutils literal"><span class="pre">getValues()</span></tt>.
<tt class="xref py py-meth docutils literal"><span class="pre">getValues()</span></tt> executes an SQL statement that returns rows of single
values and converts these to a python list.</p>
<p>Testing this data source you should see one plot:</p>
<div class="highlight-python"><pre>sphinxreport-test -t ExpressionLevel -r histogram-plot -o range=0,100,4</pre>
</div>
<p>The plots show a bi-modal distribution in the two experiments.</p>
</div>
<div class="section" id="adding-slices">
<h2>Adding slices<a class="headerlink" href="#adding-slices" title="Permalink to this headline">¶</a></h2>
<p>Adding slices is akin to adding <tt class="docutils literal"><span class="pre">WHERE</span></tt> clauses in SQL statements. Add the
following data source:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ExpressionLevelWithSlices</span><span class="p">(</span><span class="n">ExpressionLevel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Counting word size.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">getSlices</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="s">&quot;housekeeping&quot;</span><span class="p">,</span> <span class="s">&quot;regulation&quot;</span> <span class="p">)</span>

    <span class="nd">@returnSingleColumnData</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="nb">slice</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">slice</span><span class="p">:</span> <span class="n">where</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">where</span> <span class="o">=</span> <span class="s">&quot;WHERE function = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="nb">slice</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s">&quot;SELECT expression FROM </span><span class="si">%s</span><span class="s">_data </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">track</span><span class="p">,</span><span class="n">where</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValues</span><span class="p">(</span> <span class="n">statement</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>Testing this data source you should now see two plots by function:</p>
<div class="highlight-python"><pre>sphinxreport-test -t ExpressionLevel -r histogram-plot -o range=0,100,4</pre>
</div>
<p>The plot is concorporated into a restructured text document as usual:</p>
<div class="highlight-python"><pre>==========
Tutorial 4
==========

Connecting to SQL:

.. report:: Tutorial4.ExpressionLevelWithSlices
   :render: histogram-plot
   :range: 0,100,4

   Expression level in house-keeping and regulatory genes
   in two experiments.</pre>
</div>
<p>See <a class="reference internal" href="Tutorial4Demo.html#tutorial4demo"><em>Tutorial 4</em></a> to check how the result should look like.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial 4: Using SQL</a><ul>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#building-a-tracker">Building a tracker</a></li>
<li><a class="reference internal" href="#adding-slices">Adding slices</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/SphinxReport-1.0.a3/doc/Tutorial4.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../index.html">Psithon for PSI4 Documentation</a> &raquo; </li>
 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, Psi4 Project.
      Last updated on Mar 15, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>