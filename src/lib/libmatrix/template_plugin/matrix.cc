#include <libplugin/plugin.h>
#include <psi4-dec.h>
#include <libparallel/parallel.h>
#include <liboptions/liboptions.h>
#include <libmints/mints.h>
#include <libdist_matrix/dist_mat.h>
#include <libpsio/psio.hpp>

#include "libmatrix.h"

INIT_PLUGIN

namespace psi { namespace libmatrix {

extern "C" 
int read_options(std::string name, Options& options)
{
    if (name == "LIBMATRIX"|| options.read_globals()) {
    }

    return true;
}

extern "C" 
PsiReturnType libmatrix(Options& options)
{
    // NOTE: This will only initialize the "default" matrix type.
    matrix_globals::initialize(Process::arguments.argc(), Process::arguments.argv());

    Dimension m(1), n(1);
    m[0] = n[0] = 10;

    // Generate default matrices.
    //    Either dist_matrix, serial_matrix, or elemental_matrix
    //    decided at configure/compile time.
    matrix a = create_matrix("A", m, n);
    matrix b = create_matrix("B", m, n);
    a.fill(1.0);
    b.fill(2.0);
    a.add(b);
    a.print();

    // Create a dist_matrix:
    //     Generates compile error if madness is not available.
    //     NOTE: First error generated by the following line makes it obvious what the problem is.

//    dist_matrix c = create_specific_matrix<dist_matrix>("C", m, n);
//    c.print();

    // Create a serial_matrix
    //     serial_matrix is always available. Compiler errors should never be generated.
//    serial_matrix d = create_specific_matrix<serial_matrix>("D", m, n);
//    d.print();

//    d.add(c);    // throws at runtime

    // Create an elmental matrix
    //     Generates compile error if elemental is not available.
//    elemental_matrix e = create_specific_matrix<elemental_matrix>("E", m, n);

    return Success;
}

}} // End namespaces

