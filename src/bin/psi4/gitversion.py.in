import os
import subprocess

top_srcdir = "@top_srcdir@"

def write_version(version):
    version_str = "#define GIT_VERSION \"%s\"\n" % version
    if len(version) == 0:
        version_str = "#undef GIT_VERSION"

    try:
        current_file = open('gitversion.h', 'r').read()
    except IOError:
        current_file = ""

    if current_file != version_str:
        open('gitversion.h', 'w').write(version_str)
        try:
            os.remove("version.o")
        except OSError:
            pass

# Use Git to find the latest version number
command = "git log -1 --pretty=%H"
process = subprocess.Popen(command.split(), stderr=subprocess.PIPE, stdout=subprocess.PIPE)
(out, err) = process.communicate()
out = str(out).rstrip()
if process.returncode:
    out = ""

write_version(out)
